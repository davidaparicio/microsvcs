name: Auto Deploy to DEV

on:
  push:
    branches: [main]
    paths:
      - 'projects/**'
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (leave empty for auto-detect)'
        required: false
        type: choice
        options:
          - ''
          - blue
          - green
          - yellow
          - red

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed services
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            blue:
              - 'projects/blue/**'
            green:
              - 'projects/green/**'
            yellow:
              - 'projects/yellow/**'
            red:
              - 'projects/red/**'

      - name: Set matrix for changed services
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SERVICE="${{ inputs.service }}"
            if [ -n "$SERVICE" ]; then
              echo "matrix={\"service\":[\"$SERVICE\"]}" >> $GITHUB_OUTPUT
            else
              # Empty service input, deploy nothing
              echo "matrix={\"service\":[]}" >> $GITHUB_OUTPUT
            fi
          else
            # Auto-detect: use changes from paths-filter
            CHANGES='${{ steps.filter.outputs.changes }}'
            if [ "$CHANGES" == "[]" ] || [ -z "$CHANGES" ]; then
              echo "matrix={\"service\":[]}" >> $GITHUB_OUTPUT
            else
              echo "matrix={\"service\":$CHANGES}" >> $GITHUB_OUTPUT
            fi
          fi

  deploy-dev:
    needs: detect-changes
    if: needs.detect-changes.outputs.matrix != '{"service":[]}'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest image SHA from Docker Hub
        id: get-sha
        run: |
          # Get the latest commit SHA for this service
          COMMIT_SHA=$(git log -1 --format=%H -- projects/${{ matrix.service }})
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)

          # Check if image exists on Docker Hub with this SHA
          IMAGE_NAME="davidaparicio/${{ matrix.service }}"

          # Wait for CI to build the image (with timeout)
          MAX_WAIT=300  # 5 minutes
          WAIT_TIME=0
          SLEEP_INTERVAL=10

          echo "Waiting for image ${IMAGE_NAME}:sha-${SHORT_SHA} to be available..."

          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            if docker manifest inspect ${IMAGE_NAME}:sha-${SHORT_SHA} >/dev/null 2>&1; then
              echo "Image found!"
              echo "sha=sha-${SHORT_SHA}" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Image not ready yet, waiting ${SLEEP_INTERVAL}s... (${WAIT_TIME}/${MAX_WAIT}s elapsed)"
            sleep $SLEEP_INTERVAL
            WAIT_TIME=$((WAIT_TIME + SLEEP_INTERVAL))
          done

          echo "::warning::Image ${IMAGE_NAME}:sha-${SHORT_SHA} not found after ${MAX_WAIT}s, using 'latest' tag"
          echo "sha=latest" >> $GITHUB_OUTPUT

      - name: Update development kustomization
        run: |
          KUSTOMIZE_FILE="k8s/overlays/development/${{ matrix.service }}/kustomization.yaml"

          if [ ! -f "$KUSTOMIZE_FILE" ]; then
            echo "::error::Kustomization file not found: $KUSTOMIZE_FILE"
            exit 1
          fi

          # Update the newTag value using yq
          sudo snap install yq
          yq eval '.images[0].newTag = "${{ steps.get-sha.outputs.sha }}"' -i "$KUSTOMIZE_FILE"

          echo "Updated $KUSTOMIZE_FILE with image tag: ${{ steps.get-sha.outputs.sha }}"
          cat "$KUSTOMIZE_FILE"

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet k8s/overlays/development/${{ matrix.service }}/kustomization.yaml; then
            echo "No changes to commit"
            exit 0
          fi

          git add k8s/overlays/development/${{ matrix.service }}/kustomization.yaml

          COMMIT_MSG="deploy(dev): ${{ matrix.service }} ${{ steps.get-sha.outputs.sha }}

          Auto-deployed to development environment by GitHub Actions.
          Commit: ${{ github.sha }}"

          git commit -m "$COMMIT_MSG"
          git push origin main

      - name: Summary
        run: |
          echo "### âœ… Deployed to DEV" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.get-sha.outputs.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will sync within 3 minutes." >> $GITHUB_STEP_SUMMARY
