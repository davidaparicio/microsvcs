name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service name'
        required: true
        type: choice
        options:
          - blue
          - green
          - yellow
          - red
      version:
        description: 'Version from staging (e.g., 2.1.3)'
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      staging_age_hours: ${{ steps.check-age.outputs.hours }}
      staging_tag: ${{ steps.verify.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify version exists in staging
        id: verify
        run: |
          sudo snap install yq

          STAGING_KUSTOMIZE="k8s/overlays/staging/${{ inputs.service }}/kustomization.yaml"

          if [ ! -f "$STAGING_KUSTOMIZE" ]; then
            echo "::error::Staging kustomization not found: $STAGING_KUSTOMIZE"
            exit 1
          fi

          STAGING_TAG=$(yq eval '.images[0].newTag' "$STAGING_KUSTOMIZE")

          if [ "$STAGING_TAG" != "${{ inputs.version }}" ]; then
            echo "::error::Version mismatch! Staging has $STAGING_TAG but you requested ${{ inputs.version }}"
            echo "::error::Please promote to staging first or use the correct version."
            exit 1
          fi

          echo "tag=$STAGING_TAG" >> $GITHUB_OUTPUT
          echo "âœ… Version ${{ inputs.version }} is deployed in staging"

      - name: Check staging deployment age
        id: check-age
        run: |
          # Find the last commit that modified the staging kustomization
          LAST_COMMIT=$(git log -1 --format=%H -- k8s/overlays/staging/${{ inputs.service }}/kustomization.yaml)
          COMMIT_DATE=$(git show -s --format=%ct "$LAST_COMMIT")
          CURRENT_DATE=$(date +%s)
          AGE_SECONDS=$((CURRENT_DATE - COMMIT_DATE))
          AGE_HOURS=$((AGE_SECONDS / 3600))

          echo "hours=$AGE_HOURS" >> $GITHUB_OUTPUT

          echo "Staging deployment age: ${AGE_HOURS} hours"

          if [ $AGE_HOURS -lt 24 ]; then
            echo "::warning::âš ï¸  This version was deployed to staging only ${AGE_HOURS} hours ago (less than 24 hours)"
            echo "::warning::Consider waiting longer for staging validation before promoting to production."
          else
            echo "âœ… Staging deployment is ${AGE_HOURS} hours old (> 24 hours)"
          fi

      - name: Verify git tag exists
        run: |
          TAG="${{ inputs.service }}/${{ inputs.version }}"

          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Git tag $TAG does not exist. Please promote to staging first."
            exit 1
          fi

          echo "âœ… Git tag $TAG exists"

      - name: Validation summary
        run: |
          echo "### âœ… Pre-Production Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Deployment Age:** ${{ steps.check-age.outputs.hours }} hours" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ${{ steps.check-age.outputs.hours }} -lt 24 ]; then
            echo "âš ï¸  **Warning:** Deployed to staging less than 24 hours ago" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Staging soak time:** Sufficient (> 24 hours)" >> $GITHUB_STEP_SUMMARY
          fi

  approve:
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Wait for approval
        run: |
          echo "### ðŸ” Awaiting Production Approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This deployment requires approval from authorized reviewers." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Age:** ${{ needs.validate.outputs.staging_age_hours }} hours" >> $GITHUB_STEP_SUMMARY

  promote:
    needs: [validate, approve]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag Docker image for production
        run: |
          IMAGE_NAME="davidaparicio/${{ inputs.service }}"
          VERSION_TAG="${{ inputs.version }}"
          PROD_TAG="prd-${VERSION_TAG}"

          echo "Pulling version: ${IMAGE_NAME}:${VERSION_TAG}"
          docker pull "${IMAGE_NAME}:${VERSION_TAG}"

          echo "Tagging for production: ${IMAGE_NAME}:${PROD_TAG}"
          docker tag "${IMAGE_NAME}:${VERSION_TAG}" "${IMAGE_NAME}:${PROD_TAG}"

          echo "Pushing production tag: ${IMAGE_NAME}:${PROD_TAG}"
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
          docker push "${IMAGE_NAME}:${PROD_TAG}"

          echo "Production image tagged successfully"

      - name: Update production kustomization
        run: |
          sudo snap install yq
          KUSTOMIZE_FILE="k8s/overlays/production/${{ inputs.service }}/kustomization.yaml"

          if [ ! -f "$KUSTOMIZE_FILE" ]; then
            echo "::error::Production kustomization not found: $KUSTOMIZE_FILE"
            exit 1
          fi

          yq eval '.images[0].newTag = "${{ inputs.version }}"' -i "$KUSTOMIZE_FILE"

          echo "Updated $KUSTOMIZE_FILE with version: ${{ inputs.version }}"
          cat "$KUSTOMIZE_FILE"

      - name: Create production deployment record
        run: |
          # Create a deployment record in git commit message
          DEPLOY_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > /tmp/deploy-notes.txt <<EOF
          Production Deployment Record
          =============================
          Service: ${{ inputs.service }}
          Version: ${{ inputs.version }}
          Deployed: ${DEPLOY_DATE}
          Staging Age: ${{ needs.validate.outputs.staging_age_hours }} hours
          Approved By: ${{ github.actor }}
          Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Git Tag: ${{ inputs.service }}/${{ inputs.version }}
          EOF

          cat /tmp/deploy-notes.txt

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet k8s/overlays/production/${{ inputs.service }}/kustomization.yaml; then
            echo "No changes to commit"
            exit 0
          fi

          git add k8s/overlays/production/${{ inputs.service }}/kustomization.yaml

          COMMIT_MSG="deploy(production): ${{ inputs.service }} ${{ inputs.version }}

          Promoted from staging to production.
          Approved by: ${{ github.actor }}
          Staging deployment age: ${{ needs.validate.outputs.staging_age_hours }} hours
          Git Tag: ${{ inputs.service }}/${{ inputs.version }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          git commit -m "$COMMIT_MSG"
          git push origin main

      - name: Create milestone tag
        run: |
          MILESTONE_TAG="release-prd-$(date -u +%Y%m%d)"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Check if tag already exists
          if git rev-parse "$MILESTONE_TAG" >/dev/null 2>&1; then
            echo "Milestone tag $MILESTONE_TAG already exists"
          else
            TAG_MSG="Production deployment milestone: $(date -u +%Y-%m-%d)

          Services deployed:
          - ${{ inputs.service }}: ${{ inputs.version }}"

            git tag -a "$MILESTONE_TAG" -m "$TAG_MSG"
            git push origin "$MILESTONE_TAG"
            echo "Created milestone tag: $MILESTONE_TAG"
          fi

      - name: Success summary
        run: |
          echo "### ðŸŽ‰ Successfully Deployed to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Git Tag:** ${{ inputs.service }}/${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "**Approved By:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will sync production cluster within 3 minutes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitoring:**" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor application logs and metrics" >> $GITHUB_STEP_SUMMARY
          echo "- Verify health checks are passing" >> $GITHUB_STEP_SUMMARY
          echo "- Watch for any alerts or errors" >> $GITHUB_STEP_SUMMARY
